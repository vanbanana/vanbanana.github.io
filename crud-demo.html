<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CRUD æ•°æ®æµå¯è§†åŒ–</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Inter', system-ui, sans-serif; background: #0f172a; color: #f1f5f9; min-height: 100vh; padding: 16px; }
.container { max-width: 800px; margin: 0 auto; }
.header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
.header h3 { font-size: 16px; }
.btn-create { padding: 8px 16px; background: #10b981; border: none; border-radius: 6px; color: white; font-size: 13px; cursor: pointer; }
.btn-create:disabled { opacity: 0.5; }

.flow { padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; margin-bottom: 12px; }
.nodes { display: flex; align-items: center; justify-content: space-between; gap: 4px; }
.node { display: flex; flex-direction: column; align-items: center; padding: 8px 12px; background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.1); border-radius: 6px; transition: all 0.2s; }
.node span { font-size: 11px; color: #94a3b8; }
.node.on { border-color: #3b82f6; background: rgba(59,130,246,0.2); box-shadow: 0 0 15px rgba(59,130,246,0.5); }
.arr { color: #94a3b8; font-size: 14px; }
.query { margin-top: 10px; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 4px; }
.query code { font-family: 'JetBrains Mono', monospace; font-size: 11px; color: #4ade80; word-break: break-all; }

.db-section { background: #1a1a2e; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; overflow: hidden; margin-bottom: 12px; }
.db-header { padding: 8px 12px; background: #2d2d44; font-size: 12px; color: #a78bfa; font-family: monospace; }
.db-thead { display: grid; grid-template-columns: 40px 1fr 80px 80px 80px; padding: 6px 10px; background: rgba(0,0,0,0.3); color: #94a3b8; font-size: 10px; text-transform: uppercase; }
.db-row { display: grid; grid-template-columns: 40px 1fr 80px 80px 80px; padding: 8px 10px; border-bottom: 1px solid rgba(255,255,255,0.05); align-items: center; transition: all 0.3s; font-size: 12px; }
.db-row.insert { background: rgba(16,185,129,0.3); animation: flash-green 0.5s; }
.db-row.update { background: rgba(245,158,11,0.3); animation: flash-yellow 0.5s; }
.db-row.delete { background: rgba(239,68,68,0.3); animation: flash-red 0.5s; }
@keyframes flash-green { 0%,100% { background: rgba(16,185,129,0.3); } 50% { background: rgba(16,185,129,0.6); } }
@keyframes flash-yellow { 0%,100% { background: rgba(245,158,11,0.3); } 50% { background: rgba(245,158,11,0.6); } }
@keyframes flash-red { 0%,100% { background: rgba(239,68,68,0.3); } 50% { background: rgba(239,68,68,0.6); } }
.cell-title { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.cell-status { font-size: 10px; padding: 2px 6px; border-radius: 4px; text-align: center; display: inline-block; }
.cell-status.published { background: rgba(16,185,129,0.2); color: #10b981; }
.cell-status.draft { background: rgba(245,158,11,0.2); color: #f59e0b; }
.cell-actions { display: flex; gap: 4px; }
.cell-actions button { padding: 4px 8px; border: none; border-radius: 4px; font-size: 10px; cursor: pointer; background: rgba(255,255,255,0.1); color: #94a3b8; }
.cell-actions button:hover:not(:disabled) { background: rgba(255,255,255,0.2); color: white; }
.cell-actions button:disabled { opacity: 0.3; }
.cell-actions .edit { background: rgba(59,130,246,0.2); color: #3b82f6; }
.cell-actions .publish { background: rgba(16,185,129,0.2); color: #10b981; }
.cell-actions .del { background: rgba(239,68,68,0.2); color: #ef4444; }

.log { background: #0d1117; border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; }
.log-title { padding: 6px 10px; background: rgba(0,0,0,0.3); font-size: 11px; color: #94a3b8; }
.log-list { padding: 8px 10px; font-family: 'JetBrains Mono', monospace; font-size: 11px; color: #4ade80; min-height: 60px; max-height: 100px; overflow-y: auto; }
.log-list .empty { color: #94a3b8; }

.modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 100; }
.modal.show { display: flex; }
.modal-box { background: #1e293b; border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 20px; width: 90%; max-width: 360px; }
.modal-box h4 { font-size: 16px; margin-bottom: 16px; }
.field { margin-bottom: 12px; }
.field label { display: block; font-size: 12px; color: #94a3b8; margin-bottom: 4px; }
.field input, .field textarea { width: 100%; padding: 10px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: white; font-size: 14px; }
.modal-btns { display: flex; gap: 8px; justify-content: flex-end; margin-top: 16px; }
.modal-btns button { padding: 8px 16px; border: none; border-radius: 6px; font-size: 13px; cursor: pointer; }
.modal-btns .cancel { background: transparent; border: 1px solid rgba(255,255,255,0.1); color: #94a3b8; }
.modal-btns .submit { background: #3b82f6; color: white; }
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h3>ğŸ—„ï¸ CRUD æ•°æ®æµå¯è§†åŒ–</h3>
    <button class="btn-create" onclick="openCreate()">+ åˆ›å»ºæ–‡ç« </button>
  </div>

  <div class="flow">
    <div class="nodes">
      <div class="node" id="n-input"><span>ç”¨æˆ·è¾“å…¥</span></div>
      <span class="arr">â†’</span>
      <div class="node" id="n-api"><span>API</span></div>
      <span class="arr">â†’</span>
      <div class="node" id="n-controller"><span>Controller</span></div>
      <span class="arr">â†’</span>
      <div class="node" id="n-prisma"><span>Prisma</span></div>
      <span class="arr">â†’</span>
      <div class="node" id="n-db"><span>PostgreSQL</span></div>
    </div>
    <div class="query" id="queryBox" style="display:none"><code id="queryText"></code></div>
  </div>

  <div class="db-section">
    <div class="db-header">PostgreSQL: articles è¡¨</div>
    <div class="db-thead"><span>id</span><span>title</span><span>status</span><span>updated_at</span><span>æ“ä½œ</span></div>
    <div id="dbBody"></div>
  </div>

  <div class="log">
    <div class="log-title">ğŸ“‹ æ‰§è¡Œæ—¥å¿—</div>
    <div class="log-list" id="logList"><div class="empty">ç‚¹å‡»æŒ‰é’®å¼€å§‹æ¼”ç¤º CRUD æ“ä½œ</div></div>
  </div>
</div>

<div class="modal" id="modal">
  <div class="modal-box">
    <h4 id="modalTitle">åˆ›å»ºæ–‡ç« </h4>
    <div class="field"><label>æ ‡é¢˜</label><input id="inputTitle" placeholder="è¾“å…¥æ–‡ç« æ ‡é¢˜..." /></div>
    <div class="field"><label>å†…å®¹</label><textarea id="inputContent" rows="3" placeholder="è¾“å…¥æ–‡ç« å†…å®¹..."></textarea></div>
    <div class="modal-btns">
      <button class="cancel" onclick="closeModal()">å–æ¶ˆ</button>
      <button class="submit" onclick="submitForm()">ç¡®å®š</button>
    </div>
  </div>
</div>

<script>
let articles = [
  { id: 1, title: 'åšå®¢æ¶æ„è®¾è®¡', content: 'ç³»ç»Ÿæ¶æ„ä»‹ç»', status: 'PUBLISHED', updated_at: '10:30:00' }
];
let nextId = 2;
let isAnimating = false;
let modalMode = 'create';
let editingId = null;
let logs = [];

const now = () => new Date().toLocaleTimeString();
const delay = ms => new Promise(r => setTimeout(r, ms));

function render() {
  const body = document.getElementById('dbBody');
  if (articles.length === 0) {
    body.innerHTML = '<div style="padding:12px;text-align:center;color:#94a3b8;font-size:12px;">è¡¨ä¸ºç©º</div>';
    return;
  }
  body.innerHTML = articles.map(a => `
    <div class="db-row" id="row-${a.id}">
      <span>${a.id}</span>
      <span class="cell-title">${a.title}</span>
      <span><span class="cell-status ${a.status.toLowerCase()}">${a.status}</span></span>
      <span style="font-size:11px;color:#94a3b8">${a.updated_at}</span>
      <div class="cell-actions">
        <button class="edit" onclick="openEdit(${a.id})" ${isAnimating ? 'disabled' : ''}>ç¼–è¾‘</button>
        <button class="publish" onclick="publishArticle(${a.id})" ${isAnimating || a.status === 'PUBLISHED' ? 'disabled' : ''}>å‘å¸ƒ</button>
        <button class="del" onclick="deleteArticle(${a.id})" ${isAnimating ? 'disabled' : ''}>åˆ é™¤</button>
      </div>
    </div>
  `).join('');
}

function log(msg) {
  logs.push(now() + ' ' + msg);
  if (logs.length > 8) logs.shift();
  document.getElementById('logList').innerHTML = logs.map(l => '<div>' + l + '</div>').join('');
}

function clearLogs() {
  logs = [];
  document.getElementById('logList').innerHTML = '<div class="empty">ç‚¹å‡»æŒ‰é’®å¼€å§‹æ¼”ç¤º</div>';
}

function setStep(step) {
  document.querySelectorAll('.node').forEach(n => n.classList.remove('on'));
  if (step) document.getElementById('n-' + step)?.classList.add('on');
}

function setQuery(q) {
  const box = document.getElementById('queryBox');
  if (q) { box.style.display = 'block'; document.getElementById('queryText').textContent = q; }
  else { box.style.display = 'none'; }
}

function highlightRow(id, action) {
  const row = document.getElementById('row-' + id);
  if (row) { row.classList.add(action); setTimeout(() => row.classList.remove(action), 800); }
}

function openCreate() {
  if (isAnimating) return;
  modalMode = 'create'; editingId = null;
  document.getElementById('modalTitle').textContent = 'åˆ›å»ºæ–‡ç« ';
  document.getElementById('inputTitle').value = '';
  document.getElementById('inputContent').value = '';
  document.getElementById('modal').classList.add('show');
}

function openEdit(id) {
  if (isAnimating) return;
  const a = articles.find(x => x.id === id);
  if (!a) return;
  modalMode = 'edit'; editingId = id;
  document.getElementById('modalTitle').textContent = 'ç¼–è¾‘æ–‡ç« ';
  document.getElementById('inputTitle').value = a.title;
  document.getElementById('inputContent').value = a.content;
  document.getElementById('modal').classList.add('show');
}

function closeModal() { document.getElementById('modal').classList.remove('show'); }

async function submitForm() {
  const title = document.getElementById('inputTitle').value.trim();
  const content = document.getElementById('inputContent').value.trim();
  if (!title) return;
  closeModal();
  isAnimating = true; clearLogs();

  const isCreate = modalMode === 'create';
  log('ç”¨æˆ·æäº¤è¡¨å•');
  setStep('input'); await delay(400);

  log((isCreate ? 'POST' : 'PUT') + ' /api/articles' + (isCreate ? '' : '/' + editingId));
  setStep('api'); setQuery((isCreate ? 'POST' : 'PUT') + ' /api/articles { title: "' + title + '" }'); await delay(400);

  log('Controller éªŒè¯æ•°æ®');
  setStep('controller'); await delay(400);

  log('Prisma ç”Ÿæˆ ' + (isCreate ? 'INSERT' : 'UPDATE') + ' è¯­å¥');
  setStep('prisma');
  setQuery(isCreate ? 'prisma.article.create({ data: { title: "' + title + '", status: "DRAFT" } })' : 'prisma.article.update({ where: { id: ' + editingId + ' }, data: { title: "' + title + '" } })');
  await delay(400);

  log('PostgreSQL æ‰§è¡Œ ' + (isCreate ? 'INSERT' : 'UPDATE'));
  setStep('db');
  setQuery(isCreate ? "INSERT INTO articles (id, title, status) VALUES (" + nextId + ", '" + title + "', 'DRAFT')" : "UPDATE articles SET title='" + title + "' WHERE id=" + editingId);
  await delay(400);

  if (isCreate) {
    articles.push({ id: nextId, title, content, status: 'DRAFT', updated_at: now() });
    render(); highlightRow(nextId, 'insert');
    log('æ–°è¡Œå·²æ’å…¥ï¼Œid=' + nextId); nextId++;
  } else {
    const a = articles.find(x => x.id === editingId);
    if (a) { a.title = title; a.content = content; a.updated_at = now(); }
    render(); highlightRow(editingId, 'update');
    log('è¡Œ id=' + editingId + ' å·²æ›´æ–°');
  }
  await delay(600);

  setStep(null); setQuery(null); isAnimating = false; render();
}

async function publishArticle(id) {
  if (isAnimating) return;
  const a = articles.find(x => x.id === id);
  if (!a || a.status === 'PUBLISHED') return;
  isAnimating = true; clearLogs();

  log('ç”¨æˆ·ç‚¹å‡»å‘å¸ƒ'); setStep('input'); await delay(400);
  log('PUT /api/articles/' + id + '/publish'); setStep('api'); setQuery('PUT /api/articles/' + id + '/publish'); await delay(400);
  log('Controller æ£€æŸ¥æƒé™'); setStep('controller'); await delay(400);
  log('Prisma ç”Ÿæˆ UPDATE è¯­å¥'); setStep('prisma'); setQuery("prisma.article.update({ where: { id: " + id + " }, data: { status: 'PUBLISHED' } })"); await delay(400);
  log('PostgreSQL æ‰§è¡Œ UPDATE'); setStep('db'); setQuery("UPDATE articles SET status='PUBLISHED' WHERE id=" + id); await delay(400);

  a.status = 'PUBLISHED'; a.updated_at = now();
  render(); highlightRow(id, 'update');
  log('çŠ¶æ€å·²æ›´æ–°ä¸º PUBLISHED'); await delay(600);

  setStep(null); setQuery(null); isAnimating = false; render();
}

async function deleteArticle(id) {
  if (isAnimating) return;
  isAnimating = true; clearLogs();

  log('ç”¨æˆ·ç‚¹å‡»åˆ é™¤'); setStep('input'); await delay(400);
  log('DELETE /api/articles/' + id); setStep('api'); setQuery('DELETE /api/articles/' + id); await delay(400);
  log('Controller æ£€æŸ¥æƒé™'); setStep('controller'); await delay(400);
  log('Prisma ç”Ÿæˆ DELETE è¯­å¥'); setStep('prisma'); setQuery('prisma.article.delete({ where: { id: ' + id + ' } })'); await delay(400);
  log('PostgreSQL æ‰§è¡Œ DELETE'); setStep('db'); setQuery('DELETE FROM articles WHERE id=' + id); await delay(400);

  highlightRow(id, 'delete');
  log('è¡Œ id=' + id + ' å°†è¢«åˆ é™¤'); await delay(600);

  articles = articles.filter(x => x.id !== id);
  render(); log('è¡Œå·²ä»è¡¨ä¸­åˆ é™¤'); await delay(400);

  setStep(null); setQuery(null); isAnimating = false; render();
}

render();
</script>
</body>
</html>
